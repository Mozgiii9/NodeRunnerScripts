#!/bin/bash

# ะฆะฒะตัะฐ ัะตะบััะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
BOLD='\033[1m'
NC='\033[0m'

# ะคัะฝะบัะธั ะดะปั ะพัะพะฑัะฐะถะตะฝะธั ััะฟะตัะฝัั ัะพะพะฑัะตะฝะธะน
success_message() {
    echo -e "${GREEN}[โ] $1${NC}"
}

# ะคัะฝะบัะธั ะดะปั ะพัะพะฑัะฐะถะตะฝะธั ะธะฝัะพัะผะฐัะธะพะฝะฝัั ัะพะพะฑัะตะฝะธะน
info_message() {
    echo -e "${CYAN}[โน๏ธ] $1${NC}"
}

# ะคัะฝะบัะธั ะดะปั ะพัะพะฑัะฐะถะตะฝะธั ะพัะธะฑะพะบ
error_message() {
    echo -e "${RED}[โ] $1${NC}"
}

# ะคัะฝะบัะธั ะดะปั ะพัะพะฑัะฐะถะตะฝะธั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน
warning_message() {
    echo -e "${YELLOW}[โ๏ธ] $1${NC}"
}

# ะัะธััะบะฐ ัะบัะฐะฝะฐ
clear

# ะัะพะฑัะฐะถะตะฝะธะต ะปะพะณะพัะธะฟะฐ
curl -s https://raw.githubusercontent.com/Mozgiii9/NodeRunnerScripts/refs/heads/main/logo.sh | bash

# ะัะพะฑัะฐะถะตะฝะธะต ะทะฐะณะพะปะพะฒะบะฐ
echo -e "\n${BOLD}${WHITE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BOLD}${WHITE}โ      ๐ VANA ะะะขะะะะะะะะะฃะกะ            โ${NC}"
echo -e "${BOLD}${WHITE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"

# ะฃะฑะตะถะดะฐะตะผัั, ััะพ ัะบัะธะฟั ะทะฐะฟััะบะฐะตััั ั ะฟัะฐะฒะฐะผะธ root
if [ "$EUID" -ne 0 ]; then
  error_message "ะะพะถะฐะปัะนััะฐ, ะทะฐะฟัััะธัะต ัะบัะธะฟั ะพั ะธะผะตะฝะธ root (sudo)"
  exit 1
fi

# ะัะพะฑัะฐะถะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ะฟัะพัะตััะต ัััะฐะฝะพะฒะบะธ
echo -e "${BOLD}${BLUE}๐๏ธ ะฃััะฐะฝะพะฒะบะฐ ัะตัะฒะธัะฐ ะฐะฒัะพะฟะตัะตะทะฐะฟััะบะฐ Vana...${NC}\n"

echo -e "${WHITE}[${CYAN}1/6${WHITE}] ${GREEN}โ ${WHITE}๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะฝะตะพะฑัะพะดะธะผัั ะฟะฐะบะตัะพะฒ...${NC}"
# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ curl, ะตัะปะธ ะตะณะพ ะฝะตั
if ! command -v curl &> /dev/null; then
    info_message "ะฃััะฐะฝะพะฒะบะฐ curl..."
    apt-get update && apt-get install -y curl
    success_message "Curl ััะฟะตัะฝะพ ัััะฐะฝะพะฒะปะตะฝ!"
else
    success_message "Curl ัะถะต ัััะฐะฝะพะฒะปะตะฝ!"
fi
sleep 1

echo -e "${WHITE}[${CYAN}2/6${WHITE}] ${GREEN}โ ${WHITE}๐ ะกะพะทะดะฐะฝะธะต ัะบัะธะฟัะฐ ะผะพะฝะธัะพัะธะฝะณะฐ...${NC}"
info_message "ะกะพะทะดะฐัะผ ัะบัะธะฟั ะผะพะฝะธัะพัะธะฝะณะฐ /root/vana_monitor.sh..."
cat << 'EOF' > /root/vana_monitor.sh
#!/bin/bash

# ะฆะฒะตัะฐ ัะตะบััะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ะะฝัะตัะฒะฐะป ะฟัะพะฒะตัะบะธ ะฒ ัะตะบัะฝะดะฐั (5 ะผะธะฝัั)
CHECK_INTERVAL=300

# ะะปััะตะฒัะต ัะปะพะฒะฐ ะดะปั ะฟะพะธัะบะฐ ะพัะธะฑะพะบ
ERROR_PATTERNS=("ERROR" "RuntimeError" "Traceback" "exception")

echo -e "${BLUE}๐ ะะฐะฟััะบ ะผะพะฝะธัะพัะธะฝะณะฐ Vana...${NC}"
echo -e "${YELLOW}โฑ๏ธ ะะฝัะตัะฒะฐะป ะฟัะพะฒะตัะบะธ: ${CHECK_INTERVAL} ัะตะบัะฝะด${NC}"

while true; do
    echo -e "${CYAN}[$(date +"%Y-%m-%d %H:%M:%S")] ๐ ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ vana.service ะฝะฐ ะพัะธะฑะบะธ...${NC}"

    # ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะต 50 ัััะพะบ ะปะพะณะพะฒ ะทะฐ ะฟะพัะปะตะดะฝะธะต 5 ะผะธะฝัั
    LOGS=$(journalctl -u vana.service --since "5 minutes ago" -n 50)

    # ะคะปะฐะณ ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ะพัะธะฑะพะบ
    ERROR_FOUND=false

    # ะัะพะฒะตััะตะผ ะปะพะณะธ ะฝะฐ ะฝะฐะปะธัะธะต ะพัะธะฑะพะบ
    for PATTERN in "${ERROR_PATTERNS[@]}"; do
        if echo "$LOGS" | grep -i "$PATTERN" > /dev/null; then
            echo -e "${RED}[$(date +"%Y-%m-%d %H:%M:%S")] โ๏ธ ะะฐะนะดะตะฝะฐ ะพัะธะฑะบะฐ: $PATTERN${NC}"
            ERROR_FOUND=true
            break
        fi
    done

    # ะัะปะธ ะพัะธะฑะบะฐ ะฝะฐะนะดะตะฝะฐ, ะฟะตัะตะทะฐะฟััะบะฐะตะผ ัะปัะถะฑั
    if [ "$ERROR_FOUND" = true ]; then
        echo -e "${YELLOW}[$(date +"%Y-%m-%d %H:%M:%S")] ๐ ะะฑะฝะฐััะถะตะฝั ะพัะธะฑะบะธ ะฒ ะปะพะณะฐั. ะะตัะตะทะฐะฟััะบ vana.service...${NC}"
        systemctl restart vana.service
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}[$(date +"%Y-%m-%d %H:%M:%S")] โ ะกะปัะถะฑะฐ ััะฟะตัะฝะพ ะฟะตัะตะทะฐะฟััะตะฝะฐ. ะะดัะผ 30 ัะตะบัะฝะด ะฟะตัะตะด ัะปะตะดัััะตะน ะฟัะพะฒะตัะบะพะน...${NC}"
            sleep 30  # ะะฐัะผ ะฒัะตะผั ัะปัะถะฑะต ะทะฐะฟัััะธัััั
        else
            echo -e "${RED}[$(date +"%Y-%m-%d %H:%M:%S")] โ ะัะธะฑะบะฐ ะฟัะธ ะฟะตัะตะทะฐะฟััะบะต ัะปัะถะฑั!${NC}"
        fi
    else
        echo -e "${GREEN}[$(date +"%Y-%m-%d %H:%M:%S")] โ ะัะธะฑะพะบ ะฝะต ะฝะฐะนะดะตะฝะพ. ะัั ัะฐะฑะพัะฐะตั ะฝะพัะผะฐะปัะฝะพ.${NC}"
    fi

    # ะะดัะผ ะดะพ ัะปะตะดัััะตะน ะฟัะพะฒะตัะบะธ
    echo -e "${BLUE}[$(date +"%Y-%m-%d %H:%M:%S")] โฑ๏ธ ะกะปะตะดัััะฐั ะฟัะพะฒะตัะบะฐ ัะตัะตะท $CHECK_INTERVAL ัะตะบัะฝะด...${NC}"
    sleep $CHECK_INTERVAL
done
EOF
success_message "ะกะบัะธะฟั ะผะพะฝะธัะพัะธะฝะณะฐ ัะพะทะดะฐะฝ!"
sleep 1

echo -e "${WHITE}[${CYAN}3/6${WHITE}] ${GREEN}โ ${WHITE}๐ ะะฐัััะพะนะบะฐ ะฟัะฐะฒ ะดะพัััะฟะฐ...${NC}"
chmod +x /root/vana_monitor.sh
success_message "ะัะฐะฒะฐ ะดะพัััะฟะฐ ัััะฐะฝะพะฒะปะตะฝั!"
sleep 1

echo -e "${WHITE}[${CYAN}4/6${WHITE}] ${GREEN}โ ${WHITE}โ๏ธ ะกะพะทะดะฐะฝะธะต systemd-ัะตัะฒะธัะฐ...${NC}"
info_message "ะกะพะทะดะฐะตะผ ัะฐะนะป ัะตัะฒะธัะฐ /etc/systemd/system/vana_monitor.service..."
cat << 'EOF' > /etc/systemd/system/vana_monitor.service
[Unit]
Description=Vana Service Monitor and Restart
After=network.target vana.service

[Service]
ExecStart=/root/vana_monitor.sh
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF
success_message "ะคะฐะนะป ัะตัะฒะธัะฐ ัะพะทะดะฐะฝ!"
sleep 1

echo -e "${WHITE}[${CYAN}5/6${WHITE}] ${GREEN}โ ${WHITE}๐ ะะฐะฟััะบ ัะตัะฒะธัะฐ...${NC}"
info_message "ะะฐัััะฐะธะฒะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ัะตัะฒะธั..."
systemctl daemon-reload
systemctl enable vana_monitor.service
systemctl start vana_monitor.service
success_message "ะกะตัะฒะธั ะทะฐะฟััะตะฝ ะธ ะดะพะฑะฐะฒะปะตะฝ ะฒ ะฐะฒัะพะทะฐะณััะทะบั!"
sleep 1

echo -e "${WHITE}[${CYAN}6/6${WHITE}] ${GREEN}โ ${WHITE}๐ ะัะพะฒะตัะบะฐ ััะฐัััะฐ ัะตัะฒะธัะฐ...${NC}"
echo -e "${PURPLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
systemctl status vana_monitor.service
echo -e "${PURPLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

# ะะฐะบะปััะธัะตะปัะฝัะน ะฒัะฒะพะด
echo -e "\n${PURPLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ!${NC}"
echo -e "${YELLOW}๐ ะกะตัะฒะธั ะผะพะฝะธัะพัะธะฝะณะฐ Vana ะฝะฐัััะพะตะฝ ะธ ะทะฐะฟััะตะฝ.${NC}"
echo -e "${CYAN}๐ ะกะตัะฒะธั ะฑัะดะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะทะฐะฟััะบะฐัั Vana ะฟัะธ ะพะฑะฝะฐััะถะตะฝะธะธ ะพัะธะฑะพะบ.${NC}"
echo -e "${CYAN}๐ ะัะพะฒะตัะบะฐ ะฒัะฟะพะปะฝัะตััั ะบะฐะถะดัะต 5 ะผะธะฝัั.${NC}"
echo -e "${YELLOW}๐ ะะปั ะฟัะพัะผะพััะฐ ะปะพะณะพะฒ ะผะพะฝะธัะพัะธะฝะณะฐ ะธัะฟะพะปัะทัะนัะต ะบะพะผะฐะฝะดั:${NC}"
echo -e "${CYAN}   sudo journalctl -u vana_monitor.service -f${NC}"
echo -e "${PURPLE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
